---
import { Icon } from 'astro-icon/components'
import strings from '$/config/strings'

interface Props {
  id: string
  name?: string
  isCollapsed?: boolean
  collapsedHeight?: string
  class?: string
}

const {
  id,
  name,
  isCollapsed,
  collapsedHeight,
  class: className,
} = Astro.props
---

<widget-layout
  data-id={id}
  data-is-collapsed={String(isCollapsed)}
  class={className}
>
  <header>{name}</header>
  <div {id} class:list={['widget-content', { collapsed: isCollapsed }]}>
    <slot />
  </div>
  {
    isCollapsed === true && (
      <button class="expand">
        <div class="icon-wrapper">
          <Icon name="tabler:dots" />
          {strings.widget.more}
        </div>
      </button>
    )
  }
</widget-layout>

<style lang="scss" define:vars={{ 'collapsed-height': collapsedHeight }}>
  @use '$/styles/main';
  @use '$/styles/theme' as *;
  @use '$/styles/utils' as *;
  @use '$/styles/variants';

  widget-layout {
    @extend %card-base;

    padding-block-end: spacing(4);

    header {
      @include transition;
      @include font-size($text-lg);

      position: relative;
      margin-block: spacing(4) spacing(2);
      margin-inline-start: spacing(8);

      color: $color-neutral-900;

      font-weight: $font-weight-bold;

      @include variants.dark {
        color: $color-neutral-100;
      }

      &::before {
        content: '';

        position: absolute;
        block-size: spacing(4);

        inline-size: spacing(1);

        border-radius: $radius-md;

        background-color: var(--primary);
        inset-block-start: 5.5px;
        inset-inline-start: -16px;
      }
    }

    .widget-content {
      padding-inline: spacing(4);
      overflow: hidden;

      &.collapsed {
        block-size: var(--collapsed-height);
      }
    }

    button.expand {
      @extend %btn-plain;
      block-size: spacing(9);

      inline-size: stretch;
      margin-block-end: spacing(-2);
      margin-inline: spacing(4);

      border-radius: $radius-lg;

      .icon-wrapper {
        display: flex;
        position: relative;
        left: spacing(-2);
        align-items: center;
        justify-content: center;

        color: var(--primary);
        gap: spacing(2);

        svg {
          block-size: spacing(7);
          inline-size: spacing(7);
        }
      }
    }
  }
</style>

<script>
  class WidgetLayout extends HTMLElement {
    constructor() {
      super()

      if (this.dataset.isCollapsed !== 'true') {
        return
      }

      const btn = this.querySelector<HTMLButtonElement>('.expand')!
      const wrapper = document.getElementById(this.dataset.id!)!
      btn.addEventListener('click', () => {
        wrapper.classList.remove('collapsed')
        btn.style.display = 'none'
      })
    }
  }

  customElements.define('widget-layout', WidgetLayout)
</script>
