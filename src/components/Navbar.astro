---
import { Icon } from "astro-icon/components"
import DisplaySettings from "@/components/widget/DisplaySettings.svelte"
import { navBarConfig, siteConfig } from "@/config"
import NavMenuPanel from "@/components/widget/NavMenuPanel.astro"
import Search from "@/components/Search.svelte"
import { LinkPresets } from "@/constants/link-presets"
import LightDarkSwitch from "@/components/LightDarkSwitch.svelte"
import { url } from "@/utils/url-utils"

type Props = {
  class?: string | undefined
}
const { class: className } = Astro.props

const links = navBarConfig.links.map((item) =>
  typeof item === "number" ? LinkPresets[item] : item,
)
---

<div id="navbar" class="z-50 onload-animation">
  <div
    class="absolute h-8 left-0 right-0 -top-8 bg-[var(--card-bg)] transition"
  >
  </div>

  <!-- used for onload animation -->
  <div
    class:list={[
      className,
      "card-base !overflow-visible max-w-[var(--page-width)] h-[4.5rem] !rounded-t-none mx-auto flex items-center justify-between px-4",
    ]}
  >
    <a
      href={url("/")}
      class="btn-plain scale-animation rounded-lg h-[3.25rem] px-5 font-bold active:scale-95"
    >
      <div class="flex flex-row text-[var(--primary)] items-center text-md">
        <Icon
          name="material-symbols:home-outline-rounded"
          class="text-[1.75rem] mb-1 mr-2"
        />
        {siteConfig.title}
      </div>
    </a>
    <div class="hidden md:flex">
      {
        links.map((link) => {
          return (
            <a
              aria-label={link.name}
              href={link.external === true ? link.url : url(link.url)}
              target={link.external === true ? "_blank" : null}
              class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95"
            >
              <div class="flex items-center">
                {link.name}
                {link.external === true && (
                  <Icon
                    name="fa6-solid:arrow-up-right-from-square"
                    class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]"
                  />
                )}
              </div>
            </a>
          )
        })
      }
    </div>
    <div class="flex">
      <Search client:only="svelte" />
      {
        !siteConfig.themeColor.fixed && (
          <button
            aria-label="Display Settings"
            class="btn-plain scale-animation rounded-lg h-11 w-11 active:scale-90"
            id="display-settings-switch"
          >
            <Icon
              name="material-symbols:palette-outline"
              class="text-[1.25rem]"
            />
          </button>
        )
      }
      <LightDarkSwitch client:load />
      <button
        aria-label="Menu"
        name="Nav Menu"
        class="btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 md:!hidden"
        id="nav-menu-switch"
      >
        <Icon name="material-symbols:menu-rounded" class="text-[1.25rem]" />
      </button>
    </div>

    <NavMenuPanel {links} />
    <DisplaySettings client:only="svelte" />
  </div>
</div>

<script>
  function switchTheme() {
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.remove("dark")
      localStorage.setItem("theme", "light")
    } else {
      document.documentElement.classList.add("dark")
      localStorage.setItem("theme", "dark")
    }
  }

  function loadButtonScript() {
    document
      .getElementById("scheme-switch")
      ?.addEventListener("click", switchTheme)

    document
      .getElementById("display-settings-switch")
      ?.addEventListener("click", () =>
        document
          .getElementById("display-setting")
          ?.classList.toggle("float-panel-closed"),
      )

    document
      .getElementById("nav-menu-switch")
      ?.addEventListener("click", () =>
        document
          .getElementById("nav-menu-panel")
          ?.classList.toggle("float-panel-closed"),
      )
  }

  loadButtonScript()
</script>

<script is:inline define:vars={{ scriptUrl: url("/pagefind/pagefind.js") }}>
  async function loadPagefind() {
    /** @type {import("vite-plugin-pagefind/types").Pagefind} */
    const pagefind = await import(scriptUrl)
    await pagefind.options({ excerptLength: 20 })
    pagefind.init()
    window.pagefind = pagefind
    pagefind.search("") // speed up the first search
  }
  loadPagefind()
</script>
