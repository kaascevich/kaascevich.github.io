---
import { getSortedPosts } from '$/utils/content'
import type { PostsForYear } from '$/types/content'
import ArchiveGroup from '$/components/archive/ArchiveGroup.astro'

type Filter = Readonly<
  { type: 'tag'; tag: string } | { type: 'category'; category: string }
>

type Props = Readonly<{
  filter?: Filter | undefined
}>
const { filter } = Astro.props

const posts = (await getSortedPosts()).filter((post) => {
  if (filter === undefined) {
    return true
  }

  switch (filter.type) {
    case 'tag':
      return post.data.tags.includes(filter.tag)
    case 'category':
      return post.data.category === filter.category
  }
})

const groups: PostsForYear[] = Array.from(
  Map.groupBy(posts, (post) => post.data.published.getFullYear()),
  ([year, posts]) => ({ year, posts }),
).toSorted((a, b) => b.year - a.year) // sort by year, descending
---

<ol>
  {groups.map((group) => <ArchiveGroup {group} />)}
</ol>

<style lang="scss">
  @use '$/styles/main';
  @use '$/styles/theme' as *;
  @use '$/styles/utils' as *;
  @use '$/styles/variants';

  ol {
    @extend .card-base;
    padding: spacing(6) spacing(8);
  }
</style>
